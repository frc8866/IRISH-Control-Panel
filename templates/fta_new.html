<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTA Control Panel - IRISH</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fta.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="fta-panel">
        <div class="header">
            <h1>FIELD TECHNICAL ADVISOR</h1>
            <div class="subtitle">IRISH Robotics Competition Control</div>
        </div>

        <div class="match-setup-section">
            <h2>Match Setup</h2>
            
            <div class="match-info">
                <div class="info-field">
                    <label for="match-number">Match Number:</label>
                    <input type="number" id="match-number" min="1" placeholder="?" value="1">
                    <label for="match-type">Match Type:</label>
                    <select id="match-type">
                        <option value="qualification">Qualification</option>
                        <option value="playoff">Playoff</option>
                        <option value="final">Final</option>
                    </select>
                </div>
            </div>

            <div class="team-setup">
                <div class="alliance-setup red-setup">
                    <h3>Red Alliance</h3>
                    <div class="info-field">
                        <label for="red-team1">Team 1:</label>
                        <input type="number" id="red-team1" min="1" placeholder="????">
                    </div>
                    <div class="info-field">
                        <label for="red-team2">Team 2:</label>
                        <input type="number" id="red-team2" min="1" placeholder="????">
                    </div>
                </div>

                <div class="alliance-setup blue-setup">
                    <h3>Blue Alliance</h3>
                    <div class="info-field">
                        <label for="blue-team1">Team 1:</label>
                        <input type="number" id="blue-team1" min="1" placeholder="????">
                    </div>
                    <div class="info-field">
                        <label for="blue-team2">Team 2:</label>
                        <input type="number" id="blue-team2" min="1" placeholder="????">
                    </div>
                </div>
            </div>

            <div class="control-buttons">
                <div class="control-section">
                    <button id="new-match-btn" class="btn btn-warning">New Match</button>
                    <button id="update-display-btn" class="btn btn-primary">Update Display</button>
                </div>
            </div>

            <div id="validation-status" class="validation-status"></div>
        </div>

        <div class="match-control-section">
            <h2>Match Control</h2>
            
            <div class="status-display">
                <div class="status-item">
                    <span class="status-label">Match Status:</span>
                    <span id="match-status" class="status-value">Not Started</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Timer:</span>
                    <span id="timer-display" class="status-value">2:15</span>
                </div>
            </div>

            <div class="control-buttons">
                <div class="control-section">
                    <button id="start-match-btn" class="btn btn-success btn-large" disabled>START MATCH</button>
                    <button id="quick-start-btn" class="btn btn-warning btn-large" disabled>QUICK START (15s)</button>
                    <button id="stop-match-btn" class="btn btn-danger btn-large">STOP MATCH</button>
                </div>
            </div>
            
            <div id="field-fault-controls" class="field-fault-controls" style="display: none;">
                <h3>Field Fault</h3>
                <div class="control-buttons">
                    <div class="control-section">
                        <button id="field-fault-btn" class="btn btn-danger">FIELD FAULT (Pause Timer)</button>
                        <button id="resume-match-btn" class="btn btn-success" style="display: none;">RESUME MATCH</button>
                    </div>
                </div>
            </div>

            <div id="match-end-controls" class="match-end-controls" style="display: none;">
                <h3>Match Complete Controls</h3>
                <div class="control-buttons">
                    <button id="review-btn" class="btn btn-warning">Match Under Review</button>
                    <button id="showcase-btn" class="btn btn-success">Final Score Showcase</button>
                </div>
            </div>
        </div>

        <div class="match-history-section">
            <h2>Saved Match Data</h2>
            <div id="saved-matches-list" class="saved-matches-list">
                <p>No saved matches yet</p>
            </div>
            <div class="control-buttons">
                <div class="control-section">
                    <button id="save-match-btn" class="btn btn-success">Save Match Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentMatchId = null;
        let matchInProgress = false;
        let validationPassed = false;

        function fetchNextMatchNumber() {
            fetch('/api/next_match_number')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('match-number').value = data.next_match_number;
                    validateMatchData();
                })
                .catch(err => console.error('Failed to fetch next match number:', err));
        }

        // Toast notification system
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, duration);
        }

        // Confirmation dialog (non-blocking)
        function showConfirm(message, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'confirm-overlay';
            overlay.innerHTML = `
                <div class="confirm-dialog">
                    <p>${message}</p>
                    <div class="confirm-buttons">
                        <button class="btn btn-danger confirm-yes">Yes</button>
                        <button class="btn btn-secondary confirm-no">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            setTimeout(() => overlay.classList.add('show'), 10);
            
            overlay.querySelector('.confirm-yes').onclick = () => {
                overlay.classList.remove('show');
                setTimeout(() => document.body.removeChild(overlay), 300);
                onConfirm();
            };
            
            overlay.querySelector('.confirm-no').onclick = () => {
                overlay.classList.remove('show');
                setTimeout(() => document.body.removeChild(overlay), 300);
            };
        }

        // Validation function
        function validateMatchData() {
            const matchType = document.getElementById('match-type').value;
            const matchNumber = document.getElementById('match-number').value;
            const redTeam1 = document.getElementById('red-team1').value;
            const redTeam2 = document.getElementById('red-team2').value;
            const blueTeam1 = document.getElementById('blue-team1').value;
            const blueTeam2 = document.getElementById('blue-team2').value;

            const statusDiv = document.getElementById('validation-status');
            const startBtn = document.getElementById('start-match-btn');
            const quickStartBtn = document.getElementById('quick-start-btn');
            const stopBtn = document.getElementById('stop-match-btn');

            if (!matchNumber || matchNumber < 1) {
                statusDiv.innerHTML = '<span class="error">⚠️ Match number required</span>';
                validationPassed = false;
            } else if (!redTeam1 || !redTeam2 || !blueTeam1 || !blueTeam2) {
                statusDiv.innerHTML = '<span class="error">⚠️ All team numbers required</span>';
                validationPassed = false;
            } else if (!matchType) {
                statusDiv.innerHTML = '<span class="error">⚠️ Match type required</span>';
                validationPassed = false;
            } else {
                statusDiv.innerHTML = '<span class="success">✓ All data verified - Ready to start</span>';
                validationPassed = true;
            }

            // Enable/disable start buttons based on validation
            startBtn.disabled = !validationPassed || matchInProgress;
            quickStartBtn.disabled = !validationPassed || matchInProgress;
            stopBtn.disabled = !matchInProgress;
        }

        // Listen for input changes
        ['match-number', 'match-type', 'red-team1', 'red-team2', 'blue-team1', 'blue-team2'].forEach(id => {
            document.getElementById(id).addEventListener('input', validateMatchData);
        });

        // New Match button - clears form and resets
        document.getElementById('new-match-btn').addEventListener('click', () => {
            if (matchInProgress) {
                showToast('Cannot create new match while a match is in progress!', 'error');
                return;
            }
            
            if (currentMatchId) {
                showConfirm('This will clear the current match data. Are you sure?', () => {
                    clearMatchForm();
                });
                return;
            }
            
            clearMatchForm();
        });

        function clearMatchForm() {
            // Clear the match ID
            currentMatchId = null;
            matchInProgress = false;
            
            // Clear all form fields
            document.getElementById('match-number').value = '';
            document.getElementById('red-team1').value = '';
            document.getElementById('red-team2').value = '';
            document.getElementById('blue-team1').value = '';
            document.getElementById('blue-team2').value = '';
            document.getElementById('match-type').value = '';
            
            // Reset status displays
            document.getElementById('match-status').textContent = 'Not Started';
            document.getElementById('timer-display').textContent = '2:15';
            document.getElementById('validation-status').innerHTML = '';
            document.getElementById('match-end-controls').style.display = 'none';
            document.getElementById('field-fault-controls').style.display = 'none';
            
            // Refresh matches list
            loadMatchesList();
            
            // Validate (will show error since fields are empty)
            validateMatchData();

            fetchNextMatchNumber();
            
            showToast('New match form ready', 'success');
            console.log('New match form cleared and ready');
        }

        // Save match data
        document.getElementById('save-match-btn').addEventListener('click', () => {
            const btn = document.getElementById('save-match-btn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            const matchNumberRaw = document.getElementById('match-number').value;
            const matchData = {
                match_type: document.getElementById('match-type').value,
                match_id: currentMatchId,
                match_number: matchNumberRaw ? parseInt(matchNumberRaw) : undefined,
                red_team1: document.getElementById('red-team1').value,
                red_team2: document.getElementById('red-team2').value,
                blue_team1: document.getElementById('blue-team1').value,
                blue_team2: document.getElementById('blue-team2').value
            };

            socket.emit('fta_save_match', matchData);

            setTimeout(() => {
                btn.textContent = 'Save Match Data';
                btn.disabled = false;
            }, 1000);
        });

        // Update display
        document.getElementById('update-display-btn').addEventListener('click', () => {
            const btn = document.getElementById('update-display-btn');
            btn.textContent = 'Updating...';
            btn.disabled = true;

            const matchNumberRaw = document.getElementById('match-number').value;

            const matchData = {
                match_number: matchNumberRaw ? parseInt(matchNumberRaw) : undefined,
                match_type: document.getElementById('match-type').value,
                red_team1: document.getElementById('red-team1').value || '????',
                red_team2: document.getElementById('red-team2').value || '????',
                blue_team1: document.getElementById('blue-team1').value || '????',
                blue_team2: document.getElementById('blue-team2').value || '????'
            };

            socket.emit('fta_update_display', matchData);

            setTimeout(() => {
                btn.textContent = 'Update Display';
                btn.disabled = false;
            }, 1000);
        });

        // Start match
        document.getElementById('start-match-btn').addEventListener('click', () => {
            if (!validationPassed) return;
            const matchNumberRaw = document.getElementById('match-number').value;
            const matchData = {
                match_id: currentMatchId,
                match_number: matchNumberRaw ? parseInt(matchNumberRaw) : undefined,
                match_type: document.getElementById('match-type').value,
                red_team1: document.getElementById('red-team1').value,
                red_team2: document.getElementById('red-team2').value,
                blue_team1: document.getElementById('blue-team1').value,
                blue_team2: document.getElementById('blue-team2').value,
                quick_start: false
            };

            socket.emit('fta_start_match', matchData);
            matchInProgress = true;
            document.getElementById('match-status').textContent = 'In Progress';
            document.getElementById('start-match-btn').disabled = true;
            document.getElementById('quick-start-btn').disabled = true;
            document.getElementById('field-fault-controls').style.display = 'block';
            const stopBtn = document.getElementById('stop-match-btn');
            stopBtn.disabled = false;
        });

        // Quick Start (15s) match
        document.getElementById('quick-start-btn').addEventListener('click', () => {
            if (!validationPassed) return;
            const matchNumberRaw = document.getElementById('match-number').value;
            const matchData = {
                match_id: currentMatchId,
                match_number: matchNumberRaw ? parseInt(matchNumberRaw) : undefined,
                match_type: document.getElementById('match-type').value,
                red_team1: document.getElementById('red-team1').value,
                red_team2: document.getElementById('red-team2').value,
                blue_team1: document.getElementById('blue-team1').value,
                blue_team2: document.getElementById('blue-team2').value,
                quick_start: true
            };


            socket.emit('fta_start_match', matchData);
            matchInProgress = true;
            document.getElementById('match-status').textContent = 'In Progress (Quick)';
            document.getElementById('start-match-btn').disabled = true;
            document.getElementById('quick-start-btn').disabled = true;
            document.getElementById('field-fault-controls').style.display = 'block';
            const stopBtn = document.getElementById('stop-match-btn');
            stopBtn.disabled = false;
        });

        document.getElementById('stop-match-btn').addEventListener('click', () => {
            socket.emit('fta_stop_match', {});
            matchInProgress = false;
            document.getElementById('match-status').textContent = 'Stopped';
            document.getElementById('start-match-btn').disabled = false;
            document.getElementById('quick-start-btn').disabled = false;
            document.getElementById('field-fault-controls').style.display = 'none';
            document.getElementById('timer-display').textContent = '2:15';
        });
        
        // Field Fault (Pause)
        document.getElementById('field-fault-btn').addEventListener('click', () => {
            socket.emit('fta_field_fault', {});
            document.getElementById('field-fault-btn').style.display = 'none';
            document.getElementById('resume-match-btn').style.display = 'inline-block';
            document.getElementById('match-status').textContent = 'FIELD FAULT';
        });
        
        // Resume Match
        document.getElementById('resume-match-btn').addEventListener('click', () => {
            socket.emit('fta_resume_match', {});
            document.getElementById('field-fault-btn').style.display = 'inline-block';
            document.getElementById('resume-match-btn').style.display = 'none';
            document.getElementById('match-status').textContent = 'In Progress';
        });

        // Match under review
        document.getElementById('review-btn').addEventListener('click', () => {
            console.log('Review button clicked. Current match ID:', currentMatchId);
            if (!currentMatchId) {
                showToast('No match is currently loaded. The match must be started first.', 'error', 4000);
                return;
            }
            console.log('Sending fta_show_review with match_id:', currentMatchId);
            socket.emit('fta_show_review', { match_id: currentMatchId });
        });

        // Final score showcase
        document.getElementById('showcase-btn').addEventListener('click', () => {
            if (!currentMatchId) {
                showToast('No match loaded', 'error');
                return;
            }
            
            // Trigger final save with recalculation of RPs before showing postmatch
            console.log('Finalizing match scores for match ID:', currentMatchId);
            socket.emit('fta_finalize_match', { match_id: currentMatchId });
            
            // Show postmatch after a brief delay to allow backend to recalculate
            setTimeout(() => {
                socket.emit('fta_show_postmatch', { match_id: currentMatchId });
            }, 500);
        });

        // Socket listeners
        socket.on('match_started', (data) => {
            matchInProgress = true;
            currentMatchId = data.match_id; // Set the match ID when match starts
            console.log('Match started with ID:', currentMatchId);
            document.getElementById('match-status').textContent = 'In Progress';
        });

        socket.on('timer_update', (data) => {
            const minutes = Math.floor(data.time_remaining / 60);
            const seconds = data.time_remaining % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });

        socket.on('match_ended', (data) => {
            matchInProgress = false;
            document.getElementById('match-status').textContent = 'Completed';
            document.getElementById('match-end-controls').style.display = 'block';
            document.getElementById('field-fault-controls').style.display = 'none';
            
            // Disable showcase button until review is complete
            document.getElementById('showcase-btn').disabled = true;
            document.getElementById('showcase-btn').textContent = 'Final Score Showcase (Waiting for Review)';
            
            // Auto-save the match when it ends
            if (currentMatchId) {
                console.log('Match ended, auto-saving match ID:', currentMatchId);
                // Match is already saved with scores by backend, just reload it
                loadMatchesList();
            }
        });

        // Enable showcase button when review is complete
        socket.on('review_complete', (data) => {
            console.log('Review complete, enabling showcase button');
            document.getElementById('showcase-btn').disabled = false;
            document.getElementById('showcase-btn').textContent = 'Final Score Showcase';
            showToast('Review complete! You can now showcase final scores.', 'success');
        });

        socket.on('match_finalized', (data) => {
            console.log('Match finalized:', data);
            // Refresh the matches list to show updated scores/RPs
            loadMatchesList();
        });

        socket.on('match_data_saved', (data) => {
            console.log('Match data saved event received:', data);
            if (data.match_id) {
                currentMatchId = data.match_id;
                console.log('Current match ID set to:', currentMatchId);
            }
            // Refresh the matches list
            loadMatchesList();
        });

        // Function to load and display all matches
        function loadMatchesList() {
            fetch('/api/matches')
                .then(response => response.json())
                .then(matches => {
                    const matchesList = document.getElementById('saved-matches-list');
                    if (matches && matches.length > 0) {
                        matchesList.innerHTML = matches.map(match => {
                            const matchType = match.match_type || '?';
                            const redTeam1 = match.red_team1?.number || '?';
                            const redTeam2 = match.red_team2?.number || '?';
                            const blueTeam1 = match.blue_team1?.number || '?';
                            const blueTeam2 = match.blue_team2?.number || '?';
                            const redScore = match.red_score || 0;
                            const blueScore = match.blue_score || 0;
                            
                            return `
                                <div class="match-item ${match.id === currentMatchId ? 'active-match' : ''}" data-match-id="${match.id}">
                                    <div class="match-info">
                                        <strong>${matchType} ${match.match_number}</strong>
                                        <div class="match-teams">
                                            <span class="red-teams">Red: ${redTeam1}/${redTeam2}</span> vs 
                                            <span class="blue-teams">Blue: ${blueTeam1}/${blueTeam2}</span>
                                        </div>
                                        <div class="match-scores">
                                            <span class="red-score">${redScore}</span> - <span class="blue-score">${blueScore}</span>
                                        </div>
                                    </div>
                                    <div class="match-actions">
                                        <button class="btn-small btn-load" onclick="loadMatch(${match.id})">Load</button>
                                        <button class="btn-small btn-delete" onclick="deleteMatch(${match.id})">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        matchesList.innerHTML = '<p>No saved matches yet</p>';
                    }
                })
                .catch(err => {
                    console.error('Failed to load matches list:', err);
                    document.getElementById('saved-matches-list').innerHTML = '<p class="error">Failed to load matches</p>';
                });
        }

        // Function to load a specific match into the form
        function loadMatch(matchId) {
            fetch('/api/matches')
                .then(response => response.json())
                .then(matches => {
                    const match = matches.find(m => m.id === matchId);
                    if (match) {
                        currentMatchId = match.id;
                        console.log('Loaded match ID:', currentMatchId);
                        
                        document.getElementById('match-type').value = match.match_type || '';
                        document.getElementById('match-number').value = match.match_number || '';
                        document.getElementById('red-team1').value = match.red_team1?.number || '';
                        document.getElementById('red-team2').value = match.red_team2?.number || '';
                        document.getElementById('blue-team1').value = match.blue_team1?.number || '';
                        document.getElementById('blue-team2').value = match.blue_team2?.number || '';
                        
                        validateMatchData();
                        loadMatchesList(); // Refresh to show active match
                    }
                })
                .catch(err => console.error('Failed to load match:', err));
        }

        // Function to delete a match
        function deleteMatch(matchId) {
            showConfirm('Are you sure you want to delete this match? This cannot be undone.', () => {
                fetch(`/api/matches/${matchId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Match deleted:', matchId);
                        showToast('Match deleted successfully', 'success');
                        if (currentMatchId === matchId) {
                            currentMatchId = null;
                        }
                        loadMatchesList();
                    } else {
                        showToast('Failed to delete match', 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to delete match:', err);
                    showToast('Failed to delete match', 'error');
                });
            });
        }

        // Load matches list on page load (but don't auto-load any match data)
        fetch('/api/matches')
            .then(response => response.json())
            .then(matches => {
                // Just load the matches list for display
                loadMatchesList();
                console.log('Matches list loaded, form remains empty');
            })
            .catch(err => console.error('Failed to load matches:', err));

        validateMatchData();
    </script>
</body>
</html>
