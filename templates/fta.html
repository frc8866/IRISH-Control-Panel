<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTA Control Panel - IRISH</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fta.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <!-- Match Under Review Banner -->
    <div id="review-banner" class="review-banner">
        ⚠️ MATCH UNDER REVIEW ⚠️
    </div>

    <!-- Final Scores Overlay -->
    <div id="fade-overlay" class="fade-overlay">
        <div id="final-scores" class="final-scores">
            <h2>FINAL SCORES</h2>
            <div class="score-display">
                <span id="final-red-score" class="red-score">0</span>
                <span class="vs-text">-</span>
                <span id="final-blue-score" class="blue-score">0</span>
            </div>
            <div id="winner-text" class="winner-text"></div>
            <div class="rp-breakdown">
                <h3>Ranking Points</h3>
                <div class="rp-item">
                    <span>Red Alliance:</span>
                    <span id="red-rp-total">0</span>
                </div>
                <div class="rp-item">
                    <span>Blue Alliance:</span>
                    <span id="blue-rp-total">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="fta-panel">
        <div class="header">
            <h1>FIELD TECHNICAL ADVISOR</h1>
            <div class="subtitle">IRISH Robotics Competition Control</div>
        </div>

        <div class="match-info-section">
            <h2>Match Configuration</h2>
            <div class="match-info-grid">
                <div class="info-field">
                    <label for="match-number">Match Number:</label>
                    <input type="number" id="match-number" min="1" value="1">
                </div>
                <div class="info-field">
                    <label for="match-status">Status:</label>
                    <select id="match-status">
                        <option value="scheduled">Scheduled</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
            </div>

            <div class="team-inputs">
                <div class="alliance-section red-alliance">
                    <h3>Red Alliance</h3>
                    <div class="info-field">
                        <label for="red-team1">Team 1:</label>
                        <input type="number" id="red-team1" min="1" placeholder="????">
                    </div>
                    <div class="info-field">
                        <label for="red-team2">Team 2:</label>
                        <input type="number" id="red-team2" min="1" placeholder="????">
                    </div>
                </div>

                <div class="alliance-section blue-alliance">
                    <h3>Blue Alliance</h3>
                    <div class="info-field">
                        <label for="blue-team1">Team 1:</label>
                        <input type="number" id="blue-team1" min="1" placeholder="????">
                    </div>
                    <div class="info-field">
                        <label for="blue-team2">Team 2:</label>
                        <input type="number" id="blue-team2" min="1" placeholder="????">
                    </div>
                </div>
            </div>

            <div class="control-buttons" style="margin-top: 20px;">
                <button id="save-match-data" class="btn btn-success">Save Match Data</button>
                <button id="load-match-data" class="btn btn-secondary">Load Match Data</button>
                <button id="update-display" class="btn btn-primary">Update Display</button>
            </div>
        </div>

        <div class="main-controls">
            <div class="control-section">
                <h2>Match Control</h2>
                <div class="control-buttons">
                    <button id="start-match" class="btn btn-success">START MATCH</button>
                    <button id="end-match" class="btn btn-danger">END MATCH</button>
                    <button id="reset-match" class="btn btn-warning">RESET MATCH</button>
                </div>

                <h2 style="margin-top: 30px;">Display Control</h2>
                <div class="control-buttons">
                    <button id="show-prematch" class="btn btn-primary">Show Prematch</button>
                    <button id="show-live" class="btn btn-primary">Show Live Match</button>
                    <button id="show-postmatch" class="btn btn-primary">Show Postmatch</button>
                </div>
            </div>

            <div class="control-section">
                <h2>Special Functions</h2>
                <div class="control-buttons">
                    <button id="trigger-review" class="btn btn-warning">Match Under Review</button>
                    <button id="final-showcase" class="btn btn-success">Final Score Showcase</button>
                </div>

                <h2 style="margin-top: 30px;">System Status</h2>
                <div class="status-indicators">
                    <div class="status-item">
                        <div id="match-status-light" class="status-light"></div>
                        <span class="status-text">Match Status</span>
                    </div>
                    <div class="status-item">
                        <div id="display-status-light" class="status-light active"></div>
                        <span class="status-text">Display Connected</span>
                    </div>
                    <div class="status-item">
                        <div id="referee-status-light" class="status-light"></div>
                        <span class="status-text">Referee Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentMatchId = null;
        let reviewBannerTimeout = null;

        // Initialize with prematch data
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentMatch();
        });

        function loadCurrentMatch() {
            fetch('/api/matches')
                .then(response => response.json())
                .then(matches => {
                    if (matches.length > 0) {
                        const currentMatch = matches.find(m => m.status === 'scheduled') || matches[0];
                        currentMatchId = currentMatch.id;
                        populateMatchData(currentMatch);
                        updateStatusLights(currentMatch);
                    } else {
                        // No matches exist, set defaults
                        currentMatchId = null;
                        populateMatchData({
                            match_number: 1,
                            status: 'scheduled',
                            red_team1: '',
                            red_team2: '',
                            blue_team1: '',
                            blue_team2: ''
                        });
                        updateStatusLights({ status: 'scheduled' });
                    }
                });
        }

        function populateMatchData(match) {
            document.getElementById('match-number').value = match.match_number;
            document.getElementById('match-status').value = match.status;
            document.getElementById('red-team1').value = match.red_team1;
            document.getElementById('red-team2').value = match.red_team2;
            document.getElementById('blue-team1').value = match.blue_team1;
            document.getElementById('blue-team2').value = match.blue_team2;
        }

        function updateStatusLights(match) {
            const matchLight = document.getElementById('match-status-light');
            if (match.status === 'in_progress') {
                matchLight.className = 'status-light active';
            } else if (match.status === 'completed') {
                matchLight.className = 'status-light warning';
            } else {
                matchLight.className = 'status-light';
            }
        }

        // Match Control Buttons
        document.getElementById('start-match').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('fta_start_match', { match_id: currentMatchId });
            }
        });

        document.getElementById('end-match').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('fta_end_match', { match_id: currentMatchId });
            }
        });

        document.getElementById('reset-match').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset the current match? This will clear all scores.')) {
                socket.emit('fta_reset_match', { match_id: currentMatchId });
            }
        });

        // Display Control Buttons
        document.getElementById('show-prematch').addEventListener('click', () => {
            socket.emit('fta_show_prematch');
        });

        document.getElementById('show-live').addEventListener('click', () => {
            socket.emit('fta_show_live');
        });

        document.getElementById('show-postmatch').addEventListener('click', () => {
            socket.emit('fta_show_postmatch');
        });

        // Data Management
        document.getElementById('save-match-data').addEventListener('click', () => {
            const saveButton = document.getElementById('save-match-data');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;

            const matchData = {
                match_id: currentMatchId,
                match_number: parseInt(document.getElementById('match-number').value),
                red_team1: document.getElementById('red-team1').value,
                red_team2: document.getElementById('red-team2').value,
                blue_team1: document.getElementById('blue-team1').value,
                blue_team2: document.getElementById('blue-team2').value
            };
            socket.emit('save_match_data', matchData);

            // Reset button after a short delay
            setTimeout(() => {
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }, 1000);
        });

        document.getElementById('load-match-data').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('load_match_data', { match_id: currentMatchId });
            }
        });

        document.getElementById('update-display').addEventListener('click', () => {
            const updateButton = document.getElementById('update-display');
            const originalText = updateButton.textContent;
            updateButton.textContent = 'Updating...';
            updateButton.disabled = true;

            // Trigger display refresh
            socket.emit('refresh_displays');

            // Reset button after a short delay
            setTimeout(() => {
                updateButton.textContent = originalText;
                updateButton.disabled = false;
            }, 1000);
        });

        // Special Functions
        document.getElementById('trigger-review').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('trigger_review_banner', { match_id: currentMatchId });
                showReviewBanner();
            }
        });

        document.getElementById('final-showcase').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('trigger_final_score', { match_id: currentMatchId });
            }
        });

        function showReviewBanner() {
            const banner = document.getElementById('review-banner');
            banner.classList.add('show');

            // Auto-hide after 10 seconds
            if (reviewBannerTimeout) {
                clearTimeout(reviewBannerTimeout);
            }
            reviewBannerTimeout = setTimeout(() => {
                banner.classList.remove('show');
            }, 10000);
        }

        // Socket event listeners
        socket.on('match_started', (data) => {
            updateStatusLights({ status: 'in_progress' });
            document.getElementById('match-status').value = 'in_progress';
        });

        socket.on('match_ended', (data) => {
            updateStatusLights({ status: 'completed' });
            document.getElementById('match-status').value = 'completed';
        });

        socket.on('match_data_loaded', (data) => {
            if (data.match_id) {
                currentMatchId = data.match_id;
            }
            populateMatchData(data);
            updateStatusLights(data);
        });

        socket.on('match_data_saved', (data) => {
            if (data.match_id) {
                currentMatchId = data.match_id;
            }
        });

        socket.on('match_start_error', (data) => {
            console.log('Error starting match:', data.error);
        });

        function showFinalShowcase(data) {
            document.getElementById('final-red-score').textContent = data.red_score;
            document.getElementById('final-blue-score').textContent = data.blue_score;
            document.getElementById('red-rp-total').textContent = data.red_rps;
            document.getElementById('blue-rp-total').textContent = data.blue_rps;

            if (data.red_score > data.blue_score) {
                document.getElementById('winner-text').textContent = 'RED ALLIANCE WINS!';
            } else if (data.blue_score > data.red_score) {
                document.getElementById('winner-text').textContent = 'BLUE ALLIANCE WINS!';
            } else {
                document.getElementById('winner-text').textContent = 'MATCH TIED!';
            }

            const overlay = document.getElementById('fade-overlay');
            overlay.classList.add('show');

            // Auto-hide after 15 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 15000);
        }

        // Handle display navigation
        socket.on('navigate_to', (data) => {
            if (data.page === 'prematch') {
                window.open('/prematch', '_blank');
            } else if (data.page === 'display') {
                window.open('/', '_blank');
            } else if (data.page === 'postmatch') {
                window.open('/postmatch', '_blank');
            }
        });
    </script>
</body>
</html>