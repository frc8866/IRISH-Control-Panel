<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referee Control Panel - IRISH</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/referee.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

</head>
<body>
    <div class="referee-panel">
        <div class="header">
            <h1>IRISH Referee Control Panel</h1>
        </div>

        <div class="match-info">
            <h2>Current Match: <span id="match-num">?</span></h2>
            <div id="current-match">No match selected</div>
        </div>

        <div class="timer-section">
            <div class="timer-display" id="match-timer">2:15</div>
            <div id="endgame-indicator"></div>
            <div id="bonus-indicator"></div>
        </div>

        <div class="alliance-controls">
            <div class="red-controls">
                <div class="alliance-header">RED ALLIANCE</div>

                <div class="scoring-section">
                    <div class="section-title">Teleoperated Scoring</div>
                    <button class="score-btn red-btn bucket-btn" data-alliance="red" data-type="bucket">BUCKET <span class="bucket-points">(6pts)</span></button>
                    <button class="score-btn red-btn" data-alliance="red" data-type="human_bucket">HUMAN PLAYER BUCKET (3pts)</button>
                    <button class="score-btn neutral-btn" id="red-bonus-activate" data-alliance="red">Activate AND ONE BONUS</button>
                </div>

                <div class="scoring-section">
                    <div class="section-title">Endgame Scoring (BENCH)</div>
                    <button class="score-btn red-btn" data-alliance="red" data-type="park">PARK (2pts)</button>
                    <button class="score-btn red-btn" data-alliance="red" data-type="slight_ramp">Slight Ramp (6pts)</button>
                    <button class="score-btn red-btn" data-alliance="red" data-type="climb">Climb (14pts)</button>
                </div>

                <div class="scoring-section">
                    <div class="section-title">Penalties</div>
                    <button class="score-btn penalty-btn" data-alliance="red" data-type="foul">Foul (+2 to Blue)</button>
                    <button class="score-btn danger-btn" data-alliance="red" data-type="tech_foul">Tech Foul (+5 to Blue)</button>
                </div>
            </div>

            <div class="blue-controls">
                <div class="alliance-header">BLUE ALLIANCE</div>

                <div class="scoring-section">
                    <div class="section-title">Teleoperated Scoring</div>
                    <button class="score-btn blue-btn bucket-btn" data-alliance="blue" data-type="bucket">BUCKET <span class="bucket-points">(6pts)</span></button>
                    <button class="score-btn blue-btn" data-alliance="blue" data-type="human_bucket">HUMAN PLAYER BUCKET (3pts)</button>
                    <button class="score-btn neutral-btn" id="blue-bonus-activate" data-alliance="blue">Activate AND ONE BONUS</button>
                </div>

                <div class="scoring-section">
                    <div class="section-title">Endgame Scoring (BENCH)</div>
                    <button class="score-btn blue-btn" data-alliance="blue" data-type="park">PARK (2pts)</button>
                    <button class="score-btn blue-btn" data-alliance="blue" data-type="slight_ramp">Slight Ramp (6pts)</button>
                    <button class="score-btn blue-btn" data-alliance="blue" data-type="climb">Climb (14pts)</button>
                </div>

                <div class="scoring-section">
                    <div class="section-title">Penalties</div>
                    <button class="score-btn penalty-btn" data-alliance="blue" data-type="foul">Foul (+2 to Red)</button>
                    <button class="score-btn danger-btn" data-alliance="blue" data-type="tech_foul">Tech Foul (+5 to Red)</button>
                </div>
            </div>
        </div>

        <div class="current-scores">
            <div class="score-display">
                <span class="red-score">0</span> - <span class="blue-score">0</span>
            </div>
            <div class="rp-display" id="rp-display">
                RPs - Red: 0 | Blue: 0
            </div>
        </div>
    </div>

    <!-- Review Mode Overlay -->
    <div id="review-mode-overlay" class="review-overlay" style="display: none;">
        <div class="review-panel">
            <div class="review-header">
                <h2>üîç MATCH UNDER REVIEW</h2>
                <button id="exit-review-btn" class="exit-review-btn">Exit Review Mode</button>
            </div>

            <div class="review-content">
                <div class="review-section">
                    <h3>Current Match Scores</h3>
                    <div class="review-scores-display">
                        <div class="review-alliance-score red">
                            <span class="alliance-name">Red Alliance</span>
                            <span class="score-value" id="review-red-score">0</span>
                        </div>
                        <div class="review-alliance-score blue">
                            <span class="alliance-name">Blue Alliance</span>
                            <span class="score-value" id="review-blue-score">0</span>
                        </div>
                    </div>
                </div>

                <div class="review-section">
                    <h3>Scoring Events Log</h3>
                    <div id="scoring-log" class="scoring-log">
                        <p class="no-events">Loading events...</p>
                    </div>
                </div>

                <div class="review-section">
                    <h3>Add Scoring Event</h3>
                    <div class="add-event-form">
                        <div class="form-row">
                            <label>Alliance:</label>
                            <select id="add-event-alliance">
                                <option value="red">Red Alliance</option>
                                <option value="blue">Blue Alliance</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Event Type:</label>
                            <select id="add-event-type">
                                <option value="bucket_normal">Bucket (Normal) - 6pts</option>
                                <option value="bucket_bonus">Bucket (Bonus) - 12pts</option>
                                <option value="human_bucket">Human Bucket - 3pts</option>
                                <option value="park">Park - 2pts</option>
                                <option value="slight_ramp">Slight Ramp - 6pts</option>
                                <option value="climb">Climb - 14pts</option>
                                <option value="foul">Foul - +5 to opponent</option>
                                <option value="tech_foul">Tech Foul - +15 to opponent</option>
                            </select>
                        </div>
                        <button id="add-event-btn" class="add-event-btn">Add Event</button>
                    </div>
                </div>

                <div class="review-actions">
                    <button id="apply-review-btn" class="apply-btn">Save & Exit Review</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentMatchId = null;
        let redBonusActive = false;
        let blueBonusActive = false;

        // Initialize with default placeholders - wait for match_started event
        console.log('Referee panel initialized, waiting for match data...');

        function updateScores(match) {
            document.querySelector('.red-score').textContent = match.red_score;
            document.querySelector('.blue-score').textContent = match.blue_score;
            updateRPs(match);
        }

        function updateRPs(match) {
            let redRPs = 0;
            let blueRPs = 0;

            if (match.red_win_rp) redRPs += 2;
            if (match.blue_win_rp) blueRPs += 2;
            if (match.red_teleop_rp) redRPs += 1;
            if (match.blue_teleop_rp) blueRPs += 1;
            if (match.red_climb_rp) redRPs += 1;
            if (match.blue_climb_rp) blueRPs += 1;
        }

        function updateTimer(data) {
            const minutes = Math.floor(data.time_remaining / 60);
            const seconds = data.time_remaining % 60;
            document.getElementById('match-timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            if (data.is_endgame) {
                document.getElementById('endgame-indicator').textContent = 'ENDGAME - 30 SECONDS REMAINING!';
            } else {
                document.getElementById('endgame-indicator').textContent = '';
            }

            // Show bonus status for both alliances
            let bonusText = '';
            if (data.red_bonus_active) {
                bonusText += `RED BONUS: ${data.red_bonus_time}s `;
            }
            if (data.blue_bonus_active) {
                bonusText += `BLUE BONUS: ${data.blue_bonus_time}s`;
            }
            document.getElementById('bonus-indicator').textContent = bonusText;
        }

        // Scoring buttons
        document.querySelectorAll('.score-btn[data-type]').forEach(btn => {
            btn.addEventListener('click', () => {
                const alliance = btn.dataset.alliance;
                const type = btn.dataset.type;
                let points = 0;
                let eventType = type;

                // Set points based on type
                switch(type) {
                    case 'bucket':
                        // Check if bonus is active for this alliance
                        if ((alliance === 'red' && redBonusActive) || (alliance === 'blue' && blueBonusActive)) {
                            points = 12;
                            eventType = 'bucket_bonus';
                        } else {
                            points = 6;
                            eventType = 'bucket_normal';
                        }
                        break;
                    case 'human_bucket': points = 3; break;
                    case 'park': points = 2; break;
                    case 'slight_ramp': points = 6; break;
                    case 'climb': points = 14; break;
                    case 'foul': points = 2; break; // This will be added to opponent
                    case 'tech_foul': points = 5; break; // This will be added to opponent
                }

                if (currentMatchId) {
                    socket.emit('score_event', {
                        match_id: currentMatchId,
                        alliance: alliance,
                        event_type: eventType,
                        points: points
                    });
                }
            });
        });

        // Bonus activation buttons
        document.getElementById('red-bonus-activate').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('activate_bonus', { match_id: currentMatchId, alliance: 'red' });
            }
        });

        document.getElementById('blue-bonus-activate').addEventListener('click', () => {
            if (currentMatchId) {
                socket.emit('activate_bonus', { match_id: currentMatchId, alliance: 'blue' });
            }
        });
        
        // Function to update bucket button points display
        function updateBucketButtons() {
            // Update red bucket button
            const redBucketBtn = document.querySelector('.bucket-btn[data-alliance="red"] .bucket-points');
            if (redBucketBtn) {
                redBucketBtn.textContent = redBonusActive ? '(12pts - BONUS!)' : '(6pts)';
            }
            
            // Update blue bucket button
            const blueBucketBtn = document.querySelector('.bucket-btn[data-alliance="blue"] .bucket-points');
            if (blueBucketBtn) {
                blueBucketBtn.textContent = blueBonusActive ? '(12pts - BONUS!)' : '(6pts)';
            }
        }

        // Socket event listeners
        socket.on('score_updated', (data) => {
            document.querySelector('.red-score').textContent = data.red_score;
            document.querySelector('.blue-score').textContent = data.blue_score;
            
            // Fetch updated match data to get RP status
            if (currentMatchId) {
                fetch('/api/matches')
                    .then(response => response.json())
                    .then(matches => {
                        const match = matches.find(m => m.id === currentMatchId);
                        if (match) {
                            updateRPs(match);
                        }
                    });
            }
        });

        socket.on('timer_update', (data) => {
            updateTimer(data);
        });

        socket.on('endgame_started', (data) => {
            document.getElementById('endgame-indicator').textContent = 'ENDGAME - 30 SECONDS REMAINING!';
        });

        socket.on('bonus_activated', (data) => {
            if (data.alliance === 'red') {
                redBonusActive = true;
            } else if (data.alliance === 'blue') {
                blueBonusActive = true;
            }
            updateBucketButtons();
            document.getElementById('bonus-indicator').textContent = `${data.alliance.toUpperCase()} BONUS ACTIVE: 15s`;
        });

        socket.on('bonus_ended', (data) => {
            if (data.alliance === 'red') {
                redBonusActive = false;
            } else if (data.alliance === 'blue') {
                blueBonusActive = false;
            }
            updateBucketButtons();
            document.getElementById('bonus-indicator').textContent = '';
        });

        socket.on('match_started', (data) => {
            currentMatchId = data.match_id;
            redBonusActive = false;
            blueBonusActive = false;
            updateBucketButtons();
            document.getElementById('match-num').textContent = data.match_number;
            document.getElementById('current-match').innerHTML = `
                Red: ${data.red_team1}/${data.red_team2} vs Blue: ${data.blue_team1}/${data.blue_team2}
            `;
            document.querySelector('.red-score').textContent = data.red_score || 0;
            document.querySelector('.blue-score').textContent = data.blue_score || 0;
        });

        socket.on('match_ended', (data) => {
            // Don't reload - keep currentMatchId available for review mode
            console.log('Match ended. Match ID:', currentMatchId);
            // Could optionally show a notification or update UI here
        });

        // Review Mode Functionality
        let reviewMode = false;
        let matchEvents = [];

        socket.on('show_review', (data) => {
            // Set the match ID from review mode trigger
            if (data && data.match_id) {
                currentMatchId = data.match_id;
                console.log('Review mode activated for match ID:', currentMatchId);
            }
            enterReviewMode();
        });

        socket.on('hide_review', () => {
            exitReviewMode();
        });

        function enterReviewMode() {
            reviewMode = true;
            document.getElementById('review-mode-overlay').style.display = 'flex';
            loadMatchEvents();
            // Update review scores with current scores
            document.getElementById('review-red-score').textContent = document.querySelector('.red-score').textContent;
            document.getElementById('review-blue-score').textContent = document.querySelector('.blue-score').textContent;
        }

        function exitReviewMode() {
            reviewMode = false;
            document.getElementById('review-mode-overlay').style.display = 'none';
        }

        function loadMatchEvents() {
            if (!currentMatchId) {
                console.log('No current match ID');
                document.getElementById('scoring-log').innerHTML = '<p class="no-events">No match selected</p>';
                return;
            }
            
            console.log('Loading events for match:', currentMatchId);
            fetch(`/api/match_events/${currentMatchId}`)
                .then(response => response.json())
                .then(events => {
                    console.log('Loaded events:', events);
                    matchEvents = events;
                    displayScoringLog(events);
                    
                    // Also update current match scores
                    fetch('/api/matches')
                        .then(response => response.json())
                        .then(matches => {
                            const match = matches.find(m => m.id === currentMatchId);
                            if (match) {
                                document.getElementById('review-red-score').textContent = match.red_score;
                                document.getElementById('review-blue-score').textContent = match.blue_score;
                            }
                        });
                })
                .catch(err => {
                    console.error('Failed to load match events:', err);
                    document.getElementById('scoring-log').innerHTML = '<p class="error">Failed to load scoring log</p>';
                });
        }

        function displayScoringLog(events) {
            const logContainer = document.getElementById('scoring-log');
            if (!events || events.length === 0) {
                logContainer.innerHTML = '<p class="no-events">No scoring events yet</p>';
                return;
            }

            logContainer.innerHTML = events.map((event, index) => {
                const time = new Date(event.timestamp).toLocaleTimeString();
                const allianceColor = event.alliance === 'red' ? '#ff3333' : '#3333ff';
                return `
                    <div class="log-entry" data-event-id="${event.id}">
                        <span class="log-time">${time}</span>
                        <span class="log-alliance" style="color: ${allianceColor}">${event.alliance?.toUpperCase() || 'N/A'}</span>
                        <span class="log-type">${formatEventType(event.event_type)}</span>
                        <span class="log-points">+${event.points}pts</span>
                        <button class="delete-event-btn" data-event-id="${event.id}">‚ùå</button>
                    </div>
                `;
            }).join('');

            // Add delete event listeners
            document.querySelectorAll('.delete-event-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const eventId = btn.dataset.eventId;
                    deleteEvent(eventId);
                });
            });
        }

        function formatEventType(type) {
            const typeMap = {
                'bucket_normal': 'Bucket (Normal)',
                'bucket_bonus': 'Bucket (Bonus)',
                'human_bucket': 'Human Bucket',
                'park': 'Park',
                'slight_ramp': 'Slight Ramp',
                'climb': 'Climb',
                'foul': 'Foul',
                'tech_foul': 'Tech Foul'
            };
            return typeMap[type] || type;
        }

        function deleteEvent(eventId) {
            if (!confirm('Delete this scoring event?')) return;
            
            socket.emit('delete_event', { event_id: eventId, match_id: currentMatchId });
        }

        // Add event button
        document.getElementById('add-event-btn').addEventListener('click', () => {
            const alliance = document.getElementById('add-event-alliance').value;
            const eventType = document.getElementById('add-event-type').value;
            
            let points = 0;
            switch(eventType) {
                case 'bucket_normal': points = 6; break;
                case 'bucket_bonus': points = 12; break;
                case 'human_bucket': points = 3; break;
                case 'park': points = 2; break;
                case 'slight_ramp': points = 6; break;
                case 'climb': points = 14; break;
                case 'foul': points = 2; break;
                case 'tech_foul': points = 5; break;
            }
            
            if (currentMatchId) {
                socket.emit('score_event', {
                    match_id: currentMatchId,
                    alliance: alliance,
                    event_type: eventType,
                    points: points
                });
                
                // Reload events after a short delay
                setTimeout(() => {
                    loadMatchEvents();
                }, 300);
            }
        });

        // Exit review button
        document.getElementById('exit-review-btn').addEventListener('click', () => {
            exitReviewMode();
            socket.emit('fta_hide_review');
        });

        // Apply review changes button - just exit review mode
        document.getElementById('apply-review-btn').addEventListener('click', () => {
            exitReviewMode();
            socket.emit('fta_hide_review');
            // Notify that review is complete and showcase can be enabled
            socket.emit('review_complete', { match_id: currentMatchId });
        });

        // Listen for event deletions
        socket.on('event_deleted', (data) => {
            loadMatchEvents();
            // Update main scores
            document.querySelector('.red-score').textContent = data.red_score;
            document.querySelector('.blue-score').textContent = data.blue_score;
        });

        socket.on('scores_updated', (data) => {
            document.querySelector('.red-score').textContent = data.red_score;
            document.querySelector('.blue-score').textContent = data.blue_score;
        });
    </script>
</body>
</html>
